<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login ‚Äî Flavour Fleet</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
</head>

<body>

    <nav class="navbar" id="navbar">
        <div class="container">
            <a href="index.html" class="nav-logo"><span class="logo-icon">üî•</span><span>Flavour Fleet</span></a>
            <div class="nav-links" id="nav-links">
                <a href="restaurants.html">Restaurants</a>
                <a href="menu.html">Menu</a>
                <a href="offers.html" class="offers-link">Offers <span class="offers-badge">NEW</span></a>
                <a href="tracking.html">Track</a>
            </div>
            <div class="nav-actions">
                <button class="icon-btn theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="5" />
                        <line x1="12" y1="1" x2="12" y2="3" />
                        <line x1="12" y1="21" x2="12" y2="23" />
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                        <line x1="1" y1="12" x2="3" y2="12" />
                        <line x1="21" y1="12" x2="23" y2="12" />
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                    </svg>
                </button>
                <a href="cart.html" class="icon-btn nav-cart" aria-label="Cart">
                    <svg viewBox="0 0 24 24">
                        <circle cx="9" cy="21" r="1" />
                        <circle cx="20" cy="21" r="1" />
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                    </svg>
                    <span class="cart-count" id="cart-count">0</span>
                </a>
                <div class="profile-dropdown-wrapper" id="profile-dropdown-wrapper">
                    <button class="icon-btn nav-profile" aria-label="Profile">
                        <svg viewBox="0 0 24 24">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                    </button>
                    <div class="profile-dropdown" id="profile-dropdown">
                        <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
                        <a href="tracking.html"><i class="fas fa-box"></i> My Orders</a>
                        <a href="help.html"><i class="fas fa-cog"></i> Settings</a>
                        <div class="dropdown-divider"></div>
                        <a href="login.html" class="dropdown-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
                <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
            </div>
        </div>
    </nav>

    <div class="auth-page">
        <div class="auth-container animate-on-scroll">
            <div class="auth-card" id="main-auth-card">
                <h2>Welcome Back üçï</h2>
                <p class="auth-subtitle">Sign in to order your favorite food</p>

                <div class="auth-tabs">
                    <button class="auth-tab active" id="login-tab" onclick="switchTab('login')">Login</button>
                    <button class="auth-tab" id="signup-tab" onclick="switchTab('signup')">Sign Up</button>
                </div>

                <div class="social-auth">
                    <button onclick="showToast('Google login simulated!','success')">üîµ Google</button>
                    <button onclick="showToast('Apple login simulated!','success')">üçé Apple</button>
                </div>

                <div class="auth-divider">or continue with email</div>

                <!-- Role Selector -->
                <div id="role-selector"
                    style="display:flex;gap:0;border-radius:12px;overflow:hidden;border:2px solid var(--primary);margin-bottom:var(--space-lg)">
                    <button type="button" id="role-user-btn" onclick="selectRole('user')"
                        style="flex:1;padding:10px 16px;border:none;cursor:pointer;font-weight:600;font-size:0.9rem;transition:all 0.3s;background:var(--primary);color:#fff">
                        üë§ Login as User
                    </button>
                    <button type="button" id="role-admin-btn" onclick="selectRole('admin')"
                        style="flex:1;padding:10px 16px;border:none;cursor:pointer;font-weight:600;font-size:0.9rem;transition:all 0.3s;background:transparent;color:var(--text-primary)">
                        üîê Login as Admin
                    </button>
                </div>

                <form id="auth-form" onsubmit="handleAuth(event)">
                    <div class="form-group" id="name-group" style="display:none">
                        <label>Full Name</label>
                        <input type="text" id="auth-name" placeholder="Your full name">
                    </div>
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="auth-email" placeholder="you@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="auth-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <div id="password-strength" style="display:none;margin-top:6px">
                            <div style="display:flex;gap:4px;margin-bottom:4px">
                                <div class="str-seg" id="str-1"
                                    style="flex:1;height:4px;border-radius:2px;background:var(--bg-tertiary);transition:background 0.3s">
                                </div>
                                <div class="str-seg" id="str-2"
                                    style="flex:1;height:4px;border-radius:2px;background:var(--bg-tertiary);transition:background 0.3s">
                                </div>
                                <div class="str-seg" id="str-3"
                                    style="flex:1;height:4px;border-radius:2px;background:var(--bg-tertiary);transition:background 0.3s">
                                </div>
                                <div class="str-seg" id="str-4"
                                    style="flex:1;height:4px;border-radius:2px;background:var(--bg-tertiary);transition:background 0.3s">
                                </div>
                            </div>
                            <span id="str-label" style="font-size:0.7rem;color:var(--text-muted)"></span>
                        </div>
                    </div>
                    <div class="form-check" id="terms-check" style="display:none">
                        <input type="checkbox" id="terms">
                        <label for="terms">I agree to the Terms of Service</label>
                    </div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-lg)"
                        id="login-extras">
                        <div class="form-check" style="margin:0"><input type="checkbox" id="remember"><label
                                for="remember">Remember me</label></div>
                        <a href="#" onclick="showResetModal(event)"
                            style="color:var(--primary);font-size:0.85rem">Forgot password?</a>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg" style="width:100%" id="auth-submit">Sign In
                        ‚Üí</button>
                </form>
            </div>

            <!-- Password Reset Modal -->
            <div class="auth-card" id="reset-card" style="display:none">
                <h2>üîê Reset Password</h2>
                <p class="auth-subtitle" id="reset-subtitle">Enter your email to receive a reset code</p>

                <!-- Step 1: Enter Email -->
                <div id="reset-step-1">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="reset-email" placeholder="you@example.com">
                    </div>
                    <button class="btn btn-primary btn-lg" style="width:100%" onclick="requestReset()">Send Reset Code
                        ‚Üí</button>
                </div>

                <!-- Step 2: Enter Code -->
                <div id="reset-step-2" style="display:none">
                    <div class="form-group">
                        <label>6-Digit Reset Code</label>
                        <input type="text" id="reset-code" placeholder="000000" maxlength="6"
                            style="text-align:center;font-size:1.5rem;letter-spacing:0.5rem">
                    </div>
                    <button class="btn btn-primary btn-lg" style="width:100%" onclick="verifyCode()">Verify Code
                        ‚Üí</button>
                </div>

                <!-- Step 3: New Password -->
                <div id="reset-step-3" style="display:none">
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" id="reset-new-password" placeholder="Min 6 characters">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" id="reset-confirm-password" placeholder="Confirm password">
                    </div>
                    <button class="btn btn-primary btn-lg" style="width:100%" onclick="resetPassword()">Reset Password
                        ‚Üí</button>
                </div>

                <div style="margin-top:var(--space-lg);text-align:center">
                    <a href="#" onclick="hideResetModal(event)" style="color:var(--primary);font-size:0.9rem">‚Üê Back to
                        Login</a>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>
    <div class="page-loader" id="page-loader">
        <div class="loader-spinner"></div>
        <p>Loading...</p>
    </div>

    <script src="js/api.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        let mode = 'login';
        let loginRole = 'user';
        let resetToken = '';
        let resetCode = '';

        function selectRole(role) {
            loginRole = role;
            const userBtn = document.getElementById('role-user-btn');
            const adminBtn = document.getElementById('role-admin-btn');
            if (role === 'admin') {
                adminBtn.style.background = 'var(--primary)';
                adminBtn.style.color = '#fff';
                userBtn.style.background = 'transparent';
                userBtn.style.color = 'var(--text-primary)';
                document.querySelector('#main-auth-card h2').textContent = 'Admin Login \uD83D\uDD10';
                document.querySelector('#main-auth-card .auth-subtitle').textContent = 'Sign in to manage your restaurant';
                document.getElementById('auth-submit').textContent = 'Sign In as Admin \u2192';
            } else {
                userBtn.style.background = 'var(--primary)';
                userBtn.style.color = '#fff';
                adminBtn.style.background = 'transparent';
                adminBtn.style.color = 'var(--text-primary)';
                document.querySelector('#main-auth-card h2').textContent = 'Welcome Back \uD83C\uDF55';
                document.querySelector('#main-auth-card .auth-subtitle').textContent = 'Sign in to order your favorite food';
                document.getElementById('auth-submit').textContent = 'Sign In \u2192';
            }
        }

        function switchTab(tab) {
            mode = tab;
            document.getElementById('login-tab').classList.toggle('active', tab === 'login');
            document.getElementById('signup-tab').classList.toggle('active', tab === 'signup');
            document.getElementById('name-group').style.display = tab === 'signup' ? 'block' : 'none';
            document.getElementById('terms-check').style.display = tab === 'signup' ? 'flex' : 'none';
            document.getElementById('login-extras').style.display = tab === 'login' ? 'flex' : 'none';
            document.getElementById('auth-submit').textContent = tab === 'login' ? 'Sign In ‚Üí' : 'Create Account ‚Üí';
            document.querySelector('#main-auth-card h2').textContent = tab === 'login' ? 'Welcome Back üçï' : 'Join Flavour Fleet üéâ';
            document.querySelector('#main-auth-card .auth-subtitle').textContent = tab === 'login' ? 'Sign in to order your favorite food' : 'Create an account to get started';
            document.getElementById('password-strength').style.display = tab === 'signup' ? 'block' : 'none';
            document.getElementById('role-selector').style.display = tab === 'login' ? 'flex' : 'none';
            if (tab === 'login') { selectRole(loginRole); }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            if (!email || !password) { showToast('Please fill in all fields', 'error'); return; }
            if (mode === 'signup') {
                const name = document.getElementById('auth-name').value;
                if (!name) { showToast('Please enter your name', 'error'); return; }
                const result = await Auth.signup(name, email, password);
                if (result.success) { showToast('Account created! üéâ', 'success'); setTimeout(() => window.location.href = 'profile.html', 1500); }
                else { showToast(result.message, 'error'); }
            } else {
                const result = await Auth.login(email, password);
                if (result.success) {
                    showToast('Welcome back! üéâ', 'success');
                    setTimeout(async () => {
                        const urlParams = new URLSearchParams(window.location.search);
                        const redirectAdmin = urlParams.get('redirect') === 'admin' || loginRole === 'admin';
                        if (redirectAdmin) {
                            // Verify user is actually an admin
                            try {
                                const p = await fetch('/api/auth/profile', { credentials: 'include' });
                                const pd = await p.json();
                                if (pd.success && pd.user && pd.user.role === 'admin') {
                                    window.location.href = 'admin.html';
                                    return;
                                } else {
                                    showToast('Access denied ‚Äî this account is not an admin', 'error');
                                    return;
                                }
                            } catch (e) {
                                showToast('Could not verify role', 'error');
                                return;
                            }
                        }
                        window.location.href = 'profile.html';
                    }, 1200);
                }
                else { showToast(result.message, 'error'); }
            }
        }

        // ‚îÄ‚îÄ Password Reset Flow ‚îÄ‚îÄ
        function showResetModal(e) {
            e.preventDefault();
            document.getElementById('main-auth-card').style.display = 'none';
            document.getElementById('reset-card').style.display = 'block';
            document.getElementById('reset-step-1').style.display = 'block';
            document.getElementById('reset-step-2').style.display = 'none';
            document.getElementById('reset-step-3').style.display = 'none';
            document.getElementById('reset-subtitle').textContent = 'Enter your email to receive a reset code';
        }

        function hideResetModal(e) {
            e.preventDefault();
            document.getElementById('main-auth-card').style.display = 'block';
            document.getElementById('reset-card').style.display = 'none';
        }

        async function requestReset() {
            const email = document.getElementById('reset-email').value;
            if (!email) { showToast('Please enter your email', 'error'); return; }

            const result = await API.post('/auth/forgot-password', { email });
            if (result.success) {
                if (result.token) {
                    resetToken = result.token;
                    // In demo mode, show the code via toast
                    showToast(`Demo mode ‚Äî Your reset code is: ${result.code}`, 'success');
                }
                document.getElementById('reset-step-1').style.display = 'none';
                document.getElementById('reset-step-2').style.display = 'block';
                document.getElementById('reset-subtitle').textContent = 'Enter the 6-digit code sent to your email';
            } else {
                showToast(result.message || 'Something went wrong', 'error');
            }
        }

        function verifyCode() {
            resetCode = document.getElementById('reset-code').value;
            if (!resetCode || resetCode.length !== 6) {
                showToast('Please enter the 6-digit code', 'error'); return;
            }
            document.getElementById('reset-step-2').style.display = 'none';
            document.getElementById('reset-step-3').style.display = 'block';
            document.getElementById('reset-subtitle').textContent = 'Choose a strong new password';
        }

        async function resetPassword() {
            const newPass = document.getElementById('reset-new-password').value;
            const confirmPass = document.getElementById('reset-confirm-password').value;

            if (!newPass || !confirmPass) { showToast('Please fill in both fields', 'error'); return; }
            if (newPass.length < 6) { showToast('Password must be at least 6 characters', 'error'); return; }
            if (newPass !== confirmPass) { showToast('Passwords do not match', 'error'); return; }

            const result = await API.post('/auth/reset-password', {
                token: resetToken,
                code: resetCode,
                new_password: newPass
            });

            if (result.success) {
                showToast('Password reset! üéâ Please login.', 'success');
                setTimeout(() => hideResetModal(new Event('click')), 1500);
            } else {
                showToast(result.message || 'Reset failed', 'error');
            }
        }

        // Password Strength Indicator
        document.getElementById('auth-password').addEventListener('input', function () {
            if (mode !== 'signup') return;
            const val = this.value;
            let score = 0;
            if (val.length >= 6) score++;
            if (val.length >= 10) score++;
            if (/[A-Z]/.test(val) && /[a-z]/.test(val)) score++;
            if (/[0-9]/.test(val)) score++;
            if (/[^A-Za-z0-9]/.test(val)) score++;
            score = Math.min(score, 4);

            const colors = ['#ef4444', '#f59e0b', '#eab308', '#22c55e'];
            const labels = ['Weak', 'Fair', 'Good', 'Strong'];
            for (let i = 1; i <= 4; i++) {
                document.getElementById('str-' + i).style.background = i <= score ? colors[score - 1] : 'var(--bg-tertiary)';
            }
            document.getElementById('str-label').textContent = val.length > 0 ? labels[score - 1] || '' : '';
            document.getElementById('str-label').style.color = val.length > 0 ? colors[score - 1] || 'var(--text-muted)' : 'var(--text-muted)';
        });
    </script>
</body>

</html>