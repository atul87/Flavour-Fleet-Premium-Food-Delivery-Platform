<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Track Order ‚Äî Flavour Fleet</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>

    <nav class="navbar" id="navbar">
        <div class="container">
            <a href="index.html" class="nav-logo"><span class="logo-icon">üî•</span><span>Flavour Fleet</span></a>
            <div class="nav-links" id="nav-links">
                <a href="restaurants.html">Restaurants</a>
                <a href="menu.html">Menu</a>
                <a href="offers.html" class="offers-link">Offers <span class="offers-badge">NEW</span></a>
                <a href="tracking.html" class="active">Track</a>
            </div>
            <div class="nav-actions">
                <button class="icon-btn theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="5" />
                        <line x1="12" y1="1" x2="12" y2="3" />
                        <line x1="12" y1="21" x2="12" y2="23" />
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                        <line x1="1" y1="12" x2="3" y2="12" />
                        <line x1="21" y1="12" x2="23" y2="12" />
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                    </svg>
                </button>
                <a href="cart.html" class="icon-btn nav-cart" aria-label="Cart">
                    <svg viewBox="0 0 24 24">
                        <circle cx="9" cy="21" r="1" />
                        <circle cx="20" cy="21" r="1" />
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                    </svg>
                    <span class="cart-count" id="cart-count">0</span>
                </a>
                <div class="profile-dropdown-wrapper" id="profile-dropdown-wrapper">
                    <button class="icon-btn nav-profile" aria-label="Profile">
                        <svg viewBox="0 0 24 24">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                    </button>
                    <div class="profile-dropdown" id="profile-dropdown">
                        <a href="profile.html"><i class="fas fa-user"></i> Profile</a>
                        <a href="tracking.html"><i class="fas fa-box"></i> My Orders</a>
                        <a href="help.html"><i class="fas fa-cog"></i> Settings</a>
                        <div class="dropdown-divider"></div>
                        <a href="login.html" class="dropdown-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                    </div>
                </div>
                <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
            </div>
        </div>
    </nav>

    <section class="page-header">
        <div class="container">
            <h1>üìç Track Your Order</h1>
            <p>Real-time order status</p>
        </div>
    </section>

    <section class="tracking-page">
        <div class="container">
            <div class="tracking-card animate-on-scroll">
                <div class="tracking-header">
                    <h2>Order Status</h2>
                    <p class="order-id" id="order-id">ORD-DEMO123</p>
                    <p class="eta" id="eta">Estimated delivery: <strong>Calculating...</strong></p>
                    <div class="countdown-timer" id="countdown-timer">
                        <span class="timer-icon">‚è±Ô∏è</span>
                        <span class="timer-value" id="timer-value">--:--</span>
                        <span class="timer-label">remaining</span>
                    </div>
                </div>

                <div class="tracking-progress" id="tracking-progress">
                    <div class="progress-fill" id="progress-fill" style="width:0%"></div>
                    <div class="tracking-step completed" id="step-1">
                        <div class="step-dot">üìã</div>
                        <span class="step-label">Order Placed</span>
                        <span class="step-description">Your order has been confirmed</span>
                    </div>
                    <div class="tracking-step" id="step-2">
                        <div class="step-dot">üë®‚Äçüç≥</div>
                        <span class="step-label">Preparing</span>
                        <span class="step-description">Kitchen is cooking your food</span>
                    </div>
                    <div class="tracking-step" id="step-3">
                        <div class="step-dot">üöó</div>
                        <span class="step-label">Out for Delivery</span>
                        <span class="step-description">Driver is on the way to you</span>
                    </div>
                    <div class="tracking-step" id="step-4">
                        <div class="step-dot">‚úÖ</div>
                        <span class="step-label">Delivered</span>
                        <span class="step-description">Enjoy your meal!</span>
                    </div>
                </div>

                <div class="tracking-details">
                    <div class="tracking-detail-row"><span class="label">Restaurant</span><span class="value"
                            id="track-restaurant">Pizza Paradise</span></div>
                    <div class="tracking-detail-row"><span class="label">Items</span><span class="value"
                            id="track-items">‚Äî</span></div>
                    <div class="tracking-detail-row"><span class="label">Total</span><span class="value"
                            id="track-total" style="color:var(--primary)">‚Äî</span></div>
                    <div class="tracking-detail-row"><span class="label">Payment</span><span class="value">Credit Card
                            ****4242</span></div>
                </div>

                <!-- Live Map -->
                <div class="map-wrapper">
                    <div id="map"></div>
                    <div class="map-overlay">
                        <span class="map-overlay-dot"></span>
                        <span class="map-overlay-text">Live tracking active</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>¬© 2026 Flavour Fleet. All rights reserved.</p>
            </div>
        </div>
    </footer>
    <div class="toast-container" id="toast-container"></div>
    <div class="page-loader" id="page-loader">
        <div class="loader-spinner"></div>
        <p>Loading tracking...</p>
    </div>

    <script src="js/api.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Try to get current order from localStorage (set after checkout)
            let order = JSON.parse(localStorage.getItem('flavourfleet_current_order'));

            // If no current order in localStorage, try to get most recent from API
            if (!order) {
                const result = await API.get('/orders');
                if (result.success && result.orders && result.orders.length > 0) {
                    order = result.orders[0]; // most recent order
                }
            }

            // Fallback to demo
            if (!order) {
                order = { order_id: 'ORD-DEMO123', items_summary: 'Pepperoni Pizza, Butter Chicken', total: 31.98, restaurant: 'Pizza Paradise' };
            }

            const displayId = order.order_id || order.id || 'ORD-DEMO123';
            const displayItems = order.items_summary || (Array.isArray(order.items) ? order.items.map(i => i.name).join(', ') : order.items) || '‚Äî';

            document.getElementById('order-id').textContent = displayId;
            document.getElementById('track-restaurant').textContent = order.restaurant || 'Pizza Paradise';
            document.getElementById('track-items').textContent = displayItems;
            document.getElementById('track-total').textContent = order.total ? '$' + Number(order.total).toFixed(2) : '‚Äî';

            // Countdown timer
            let totalSeconds = 25 * 60; // 25 minutes
            const timerEl = document.getElementById('timer-value');
            function updateTimer() {
                if (totalSeconds <= 0) {
                    timerEl.textContent = '00:00';
                    return;
                }
                const mins = Math.floor(totalSeconds / 60);
                const secs = totalSeconds % 60;
                timerEl.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                totalSeconds--;
                setTimeout(updateTimer, 1000);
            }
            updateTimer();

            let step = 1;
            const etas = ['25 min üç≥', '18 min üë®‚Äçüç≥', '8 min üöó', 'Delivered! ü•≥'];
            const statusNames = ['Placed', 'Preparing', 'Out for Delivery', 'Delivered'];

            function simulateProgress() {
                if (step > 4) return;

                // Write current status to localStorage for the Active Order Pill
                localStorage.setItem('flavourfleet_order_status', statusNames[step - 1]);

                document.getElementById('progress-fill').style.width = ((step - 1) / 3 * 100) + '%';
                for (let i = 1; i <= 4; i++) {
                    const el = document.getElementById('step-' + i);
                    el.classList.remove('completed', 'active');
                    if (i < step) el.classList.add('completed');
                    else if (i === step) el.classList.add('active');
                }
                document.getElementById('eta').innerHTML = 'Estimated delivery: <strong>' + etas[Math.min(step - 1, 3)] + '</strong>';

                // Update countdown on each step
                if (step === 2) totalSeconds = 18 * 60;
                if (step === 3) totalSeconds = 8 * 60;
                if (step === 4) {
                    totalSeconds = 0;
                    document.getElementById('countdown-timer').style.background = 'rgba(46, 196, 182, 0.15)';
                    timerEl.textContent = '‚úÖ';
                    // Clear status after delivery (pill will auto-hide)
                    setTimeout(() => localStorage.removeItem('flavourfleet_order_status'), 3000);
                }

                step++;
                if (step <= 5) setTimeout(simulateProgress, 4000);
            }
            simulateProgress();

            // ===== LEAFLET MAP =====
            const restaurantLat = 19.0760, restaurantLng = 72.8777;
            const deliveryLat = 19.0920, deliveryLng = 72.9050;

            // Pick tile layer based on theme
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const tileUrl = isDark
                ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
                : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';

            const map = L.map('map', { zoomControl: false, attributionControl: false }).setView(
                [(restaurantLat + deliveryLat) / 2, (restaurantLng + deliveryLng) / 2], 14
            );
            L.control.zoom({ position: 'topright' }).addTo(map);
            L.tileLayer(tileUrl, { maxZoom: 19 }).addTo(map);

            // Custom emoji markers
            function emojiIcon(emoji, size = 32) {
                return L.divIcon({
                    html: `<span style="font-size:${size}px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.4))">${emoji}</span>`,
                    className: 'emoji-marker',
                    iconSize: [size, size],
                    iconAnchor: [size / 2, size / 2]
                });
            }

            // Restaurant marker
            L.marker([restaurantLat, restaurantLng], { icon: emojiIcon('üçî', 36) })
                .addTo(map)
                .bindPopup('<b>Pizza Paradise</b><br>Restaurant');

            // Delivery marker (bouncing)
            const deliveryMarker = L.marker([deliveryLat, deliveryLng], { icon: emojiIcon('üè†', 36) })
                .addTo(map)
                .bindPopup('<b>Your Address</b><br>Delivery location');

            // ETA radius circle
            const etaCircle = L.circle([deliveryLat, deliveryLng], {
                radius: 600, color: '#ff6b35', fillColor: '#ff6b35',
                fillOpacity: 0.08, weight: 2, dashArray: '8 6'
            }).addTo(map);

            // Route line (curved waypoints for realism)
            const routePoints = [
                [restaurantLat, restaurantLng],
                [19.0785, 72.8850],
                [19.0810, 72.8910],
                [19.0850, 72.8950],
                [19.0880, 72.8990],
                [deliveryLat, deliveryLng]
            ];
            L.polyline(routePoints, {
                color: '#ff6b35', weight: 4, opacity: 0.7,
                dashArray: '12 8', lineCap: 'round'
            }).addTo(map);

            // Animated driver marker
            const driverMarker = L.marker([restaurantLat, restaurantLng], {
                icon: emojiIcon('üõµ', 40), zIndexOffset: 1000
            }).addTo(map).bindPopup('Your delivery driver');

            // Animate driver along route
            let routeIndex = 0;
            function animateDriver() {
                if (routeIndex >= routePoints.length) {
                    driverMarker.setIcon(emojiIcon('‚úÖ', 40));
                    driverMarker.setPopupContent('Delivered! üéâ').openPopup();
                    etaCircle.setStyle({ color: '#2ec4b6', fillColor: '#2ec4b6', fillOpacity: 0.12 });
                    return;
                }
                const [lat, lng] = routePoints[routeIndex];
                driverMarker.setLatLng([lat, lng]);
                routeIndex++;
                setTimeout(animateDriver, 3500);
            }
            // Start driver after 2s
            setTimeout(animateDriver, 2000);
        });
    </script>

    <!-- MOBILE BOTTOM NAV -->
    <nav class="bottom-nav" id="bottom-nav">
        <div class="nav-items">
            <a href="index.html" class="nav-item">
                <span class="nav-icon">üè†</span>
                <span>Home</span>
            </a>
            <a href="menu.html" class="nav-item">
                <span class="nav-icon">üçΩÔ∏è</span>
                <span>Menu</span>
            </a>
            <a href="cart.html" class="nav-item">
                <span class="nav-icon">üõí</span>
                <span>Cart</span>
                <span class="nav-badge cart-count" style="display:none">0</span>
            </a>
            <a href="tracking.html" class="nav-item active">
                <span class="nav-icon">üìç</span>
                <span>Orders</span>
            </a>
            <a href="profile.html" class="nav-item">
                <span class="nav-icon">üë§</span>
                <span>Profile</span>
            </a>
        </div>
    </nav>

</body>

</html>