<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout ‚Äî Flavour Fleet</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/animations.css">
</head>

<body>

    <nav class="navbar" id="navbar">
        <div class="container">
            <a href="index.html" class="nav-logo"><span class="logo-icon">üî•</span><span>Flavour Fleet</span></a>
            <div class="nav-links" id="nav-links">
                <a href="index.html">Home</a>
                <a href="restaurants.html">Restaurants</a>
                <a href="menu.html">Menu</a>
                <a href="offers.html" class="offers-link">Offers <span class="offers-badge">NEW</span></a>
                <a href="tracking.html">Track Order</a>
            </div>
            <div class="nav-actions">
                <button class="icon-btn theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <svg viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="5" />
                        <line x1="12" y1="1" x2="12" y2="3" />
                        <line x1="12" y1="21" x2="12" y2="23" />
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                        <line x1="1" y1="12" x2="3" y2="12" />
                        <line x1="21" y1="12" x2="23" y2="12" />
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                    </svg>
                </button>
                <a href="cart.html" class="icon-btn nav-cart" aria-label="Cart">
                    <svg viewBox="0 0 24 24">
                        <circle cx="9" cy="21" r="1" />
                        <circle cx="20" cy="21" r="1" />
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" />
                    </svg>
                    <span class="cart-count" id="cart-count">0</span>
                </a>
                <a href="profile.html" class="icon-btn nav-profile" aria-label="Profile">
                    <svg viewBox="0 0 24 24">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                </a>
                <div class="hamburger" id="hamburger"><span></span><span></span><span></span></div>
            </div>
        </div>
    </nav>

    <section class="page-header">
        <div class="container">
            <h1>üí≥ Checkout</h1>
            <p>Complete your order</p>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <div class="checkout-layout">
                <div>
                    <div class="glass-card" style="padding:var(--space-xl);margin-bottom:var(--space-xl)">
                        <h3 style="margin-bottom:var(--space-lg)">üìç Delivery Details</h3>
                        <div class="form-row">
                            <div class="form-group"><label>Full Name</label><input type="text" id="checkout-name"
                                    placeholder="John Doe"></div>
                            <div class="form-group"><label>Phone Number</label><input type="tel" id="checkout-phone"
                                    placeholder="+1 (555) 000-0000"></div>
                        </div>
                        <div class="form-group"><label>Delivery Address</label><input type="text" id="checkout-address"
                                placeholder="123 Main Street, Apt 4B"></div>
                        <div class="form-row">
                            <div class="form-group"><label>City</label><input type="text" id="checkout-city"
                                    placeholder="New York"></div>
                            <div class="form-group"><label>ZIP Code</label><input type="text" id="checkout-zip"
                                    placeholder="10001"></div>
                        </div>
                        <div class="form-group"><label>Delivery Instructions</label><textarea id="checkout-instructions"
                                rows="3" placeholder="Leave at door, ring doorbell..."
                                style="width:100%;padding:0.75rem 1rem;border-radius:var(--radius-md);background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-primary);resize:vertical"></textarea>
                        </div>
                    </div>

                    <div class="glass-card" style="padding:var(--space-xl)">
                        <h3 style="margin-bottom:var(--space-lg)">üí≥ Payment Method</h3>
                        <div class="payment-methods">
                            <div class="payment-method active" onclick="selectPayment(this)"><span
                                    class="payment-icon">üí≥</span><span>Credit Card</span></div>
                            <div class="payment-method" onclick="selectPayment(this)"><span
                                    class="payment-icon">üì±</span><span>Google Pay</span></div>
                            <div class="payment-method" onclick="selectPayment(this)"><span
                                    class="payment-icon">üè¶</span><span>PayPal</span></div>
                        </div>
                        <div id="card-fields">
                            <div class="form-group"><label>Card Number</label><input type="text"
                                    placeholder="4242 4242 4242 4242"></div>
                            <div class="form-row">
                                <div class="form-group"><label>Expiry Date</label><input type="text"
                                        placeholder="MM/YY"></div>
                                <div class="form-group"><label>CVV</label><input type="text" placeholder="123"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="cart-summary">
                        <h3>Order Summary</h3>
                        <div id="checkout-items"></div>
                        <div id="checkout-summary"></div>
                        <button class="btn btn-primary btn-lg" style="width:100%;margin-top:var(--space-lg)"
                            onclick="placeOrder()">üéâ Place Order</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>¬© 2026 Flavour Fleet. All rights reserved.</p>
            </div>
        </div>
    </footer>
    <div class="toast-container" id="toast-container"></div>
    <div class="page-loader" id="page-loader">
        <div class="loader-spinner"></div>
        <p>Loading checkout...</p>
    </div>

    <script src="js/api.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/main.js"></script>
    <script>
        function selectPayment(el) {
            document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
            el.classList.add('active');
        }
        async function renderCheckout() {
            await Cart.syncFromServer();
            const items = Cart.getCart();
            const itemsEl = document.getElementById('checkout-items');
            const summaryEl = document.getElementById('checkout-summary');
            if (!items.length) {
                itemsEl.innerHTML = '<p style="color:var(--text-muted)">Your cart is empty. <a href="menu.html" style="color:var(--primary)">Browse Menu</a></p>';
                return;
            }
            itemsEl.innerHTML = items.map(i => `<div style="display:flex;justify-content:space-between;margin-bottom:var(--space-sm);font-size:0.9rem"><span>${i.name} √ó ${i.quantity}</span><span>$${(i.price * i.quantity).toFixed(2)}</span></div>`).join('');
            const sub = Cart.getSubtotal();
            const tax = Cart.getTax();
            const del = Cart.getDeliveryFee();
            const total = Cart.getTotal();
            summaryEl.innerHTML = `<div class="summary-row"><span>Subtotal</span><span>$${sub.toFixed(2)}</span></div><div class="summary-row"><span>Delivery Fee</span><span>$${del.toFixed(2)}</span></div><div class="summary-row"><span>Tax</span><span>$${tax.toFixed(2)}</span></div><div class="summary-row total"><span>Total</span><span>$${total.toFixed(2)}</span></div>`;
        }
        async function placeOrder() {
            await Cart.syncFromServer();
            const items = Cart.getCart();
            if (!items.length) { showToast('Cart is empty!', 'error'); return; }

            // --- Fix 4: Checkout Validation ---
            const fields = [
                { id: 'checkout-name', label: 'Full Name', required: true },
                { id: 'checkout-phone', label: 'Phone Number', required: true, pattern: /^\+?[\d\s\-()]{7,15}$/, patternMsg: 'Enter a valid phone number (7-15 digits)' },
                { id: 'checkout-address', label: 'Delivery Address', required: true },
                { id: 'checkout-city', label: 'City', required: true },
                { id: 'checkout-zip', label: 'ZIP Code', required: true }
            ];

            // Clear previous errors
            document.querySelectorAll('.checkout-error').forEach(el => el.remove());
            document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));

            let hasError = false;
            for (const field of fields) {
                const input = document.getElementById(field.id);
                if (!input) continue;
                const val = input.value.trim();

                let errorMsg = '';
                if (field.required && !val) {
                    errorMsg = `${field.label} is required`;
                } else if (field.pattern && val && !field.pattern.test(val)) {
                    errorMsg = field.patternMsg;
                }

                if (errorMsg) {
                    hasError = true;
                    input.style.borderColor = '#ef4444';
                    input.classList.add('field-error');
                    const errEl = document.createElement('span');
                    errEl.className = 'checkout-error';
                    errEl.style.cssText = 'color:#ef4444;font-size:0.75rem;display:block;margin-top:2px';
                    errEl.textContent = errorMsg;
                    input.parentNode.appendChild(errEl);
                } else {
                    input.style.borderColor = '';
                }
            }

            if (hasError) {
                showToast('Please fix the errors above', 'error');
                return;
            }

            // Disable button to prevent double-click
            const btn = document.querySelector('.btn-primary.btn-lg');
            if (btn) { btn.disabled = true; btn.textContent = '‚è≥ Placing Order...'; }

            const orderData = {
                name: document.getElementById('checkout-name')?.value || '',
                phone: document.getElementById('checkout-phone')?.value || '',
                address: document.getElementById('checkout-address')?.value || '',
                city: document.getElementById('checkout-city')?.value || '',
                zip: document.getElementById('checkout-zip')?.value || '',
                instructions: document.getElementById('checkout-instructions')?.value || '',
                payment_method: document.querySelector('.payment-method.active')?.textContent?.trim() || 'Credit Card',
                discount: 0
            };

            const result = await API.post('/orders', orderData);
            if (result.success) {
                // Store current order for tracking page
                localStorage.setItem('flavourfleet_current_order', JSON.stringify(result.order));
                showToast(result.message || 'Order placed successfully! üéâ', 'success');
                setTimeout(() => { window.location.href = 'order-confirmation.html'; }, 1500);
            } else {
                showToast(result.message || 'Failed to place order', 'error');
                if (btn) { btn.disabled = false; btn.textContent = 'üéâ Place Order'; }
            }
        }
        document.addEventListener('DOMContentLoaded', renderCheckout);
    </script>
</body>

</html>